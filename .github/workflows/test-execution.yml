name: Hybrid Automation Suite

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' 

jobs:
  build-and-test:
    runs-on: ubuntu-latest 

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven

    # --- NEW DOCKER STEPS ---
    - name: Start Selenium Grid via Docker Compose
      run: docker-compose up -d

    - name: Wait for Selenium Grid to be Ready
      # The Grid takes a few seconds to fully boot up. We pause the pipeline for 15 seconds to ensure it is ready to accept tests.
      run: sleep 15 
      
    - name: Verify Grid Status
      # Pings the Grid to log its status in the GitHub Actions console
      run: curl -s http://localhost:4444/status | grep "ready"

    # --- EXISTING TEST EXECUTION ---
    - name: Run Maven Tests
      continue-on-error: true 
      # Ensure your config.properties in GitHub has run_on_grid=true
      run: mvn clean test -DsuiteXmlFile=testng.xml

    # --- NEW DOCKER TEARDOWN ---
    - name: Stop and Remove Selenium Grid
      # Runs regardless of whether tests passed or failed
      if: always() 
      run: docker-compose down

    # --- EXISTING REPORTING ---
    - name: Upload Extent Report and Logs
      uses: actions/upload-artifact@v3
      # Runs regardless of whether tests passed or failed
      if: always() 
      with:
        name: Automation-Test-Results
        path: |
          test-output/ExtentReport.html
          logs/automation.log